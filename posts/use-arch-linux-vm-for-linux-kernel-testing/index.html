<!doctype html><html>
<head>
<title>
Use Arch Linux VM for Linux Kernel Testing
</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=author content="Robertus Chris">
<link rel="shortcut icon" type=image/x-icon href=https://bruhtus.github.io/img/favicon.ico>
<link rel=stylesheet href=https://bruhtus.github.io/style.min.4f970aa135421035a71bdc9bbd750aa2cfbe0ddb080ab1ec5db4173f45494cad.css integrity="sha256-T5cKoTVCEDWnG9ybvXUKos++DdsICrHsXbQXP0VJTK0=">
<link disabled rel=stylesheet href=https://bruhtus.github.io/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB+BLd7VPoFFdCmg9OezbJR26lg/h+Wb3/zb8I=">
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.8.1/css/all.css integrity=sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf crossorigin=anonymous>
<link rel=preconnect href=https://fonts.gstatic.com>
<link href="https://fonts.googleapis.com/css2?family=Bitter:wght@300&family=EB+Garamond&family=PT+Sans&family=Sura&family=Zilla+Slab&family=Inconsolata&family=Libre+Baskerville&display=swap" rel=stylesheet>
<link rel=stylesheet href=https://bruhtus.github.io/css/custom.css>
<meta property="og:title" content="Use Arch Linux VM for Linux Kernel Testing">
<meta property="og:description" content="A Brief Intro Have you wondered &ldquo;how can we test a linux kernel without breaking our linux operating system installation?&rdquo;. One of the method is using virtual machine (VM) and in this post we&rsquo;ll use arch linux in virtual machine to try out different version of linux kernel.
There are 2 scenarios that we will discuss on this post:
 Using arch linux VM with arch linux as host system. Using arch linux VM with different linux distro as host system.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://bruhtus.github.io/posts/use-arch-linux-vm-for-linux-kernel-testing/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2025-03-30T11:14:44+07:00">
<meta property="article:modified_time" content="2025-03-30T11:14:44+07:00">
<meta itemprop=name content="Use Arch Linux VM for Linux Kernel Testing">
<meta itemprop=description content="A Brief Intro Have you wondered &ldquo;how can we test a linux kernel without breaking our linux operating system installation?&rdquo;. One of the method is using virtual machine (VM) and in this post we&rsquo;ll use arch linux in virtual machine to try out different version of linux kernel.
There are 2 scenarios that we will discuss on this post:
 Using arch linux VM with arch linux as host system. Using arch linux VM with different linux distro as host system."><meta itemprop=datePublished content="2025-03-30T11:14:44+07:00">
<meta itemprop=dateModified content="2025-03-30T11:14:44+07:00">
<meta itemprop=wordCount content="1620">
<meta itemprop=keywords content="Linux,"><meta name=twitter:card content="summary">
<meta name=twitter:image content="https://bruhtus.github.io//img/">
<meta name=twitter:title content="Use Arch Linux VM for Linux Kernel Testing">
<meta name=twitter:description content="A Brief Intro Have you wondered &ldquo;how can we test a linux kernel without breaking our linux operating system installation?&rdquo;. One of the method is using virtual machine (VM) and in this post we&rsquo;ll use arch linux in virtual machine to try out different version of linux kernel.
There are 2 scenarios that we will discuss on this post:
 Using arch linux VM with arch linux as host system. Using arch linux VM with different linux distro as host system."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<h1>Use Arch Linux VM for Linux Kernel Testing</h1>
<header>
<div class=cd>
<h2><a style=text-decoration:none class=cd href=https://bruhtus.github.io/posts>cd ..</a> || <a style=text-decoration:none class=cd href=https://bruhtus.github.io/>cd</a></h2>
</div>
</header>
<p class=date>
March 30, 2025
<span>&#183;</span>
8 mins
<span>&#183;</span>
Robertus Chris
</p>
<div id=tags>
<ul>
<li><a style=text-decoration:none href=https://bruhtus.github.io/tags/linux/>Linux</a></li>
</ul>
</div>
<div class=toc>
<details>
<summary>
<div class=details>Table of Contents</div>
</summary>
<blockquote><ul><li>
<a style=text-decoration:none href=#a-brief-intro aria-label="A Brief Intro">A Brief Intro</a></li><li>
<a style=text-decoration:none href=#arch-linux-as-host-system aria-label="Arch Linux as Host System">Arch Linux as Host System</a><ul>
<li>
<a style=text-decoration:none href=#use-custom-linux-kernel-on-qemu-vm aria-label="Use Custom Linux Kernel on QEMU VM">Use Custom Linux Kernel on QEMU VM</a></li></ul>
</li><li>
<a style=text-decoration:none href=#another-linux-distro-as-host-system aria-label="Another Linux Distro as Host System">Another Linux Distro as Host System</a><ul>
<li>
<a style=text-decoration:none href=#use-custom-linux-kernel-on-qemu-vm-1 aria-label="Use Custom Linux Kernel on QEMU VM">Use Custom Linux Kernel on QEMU VM</a></li></ul>
</li><li>
<a style=text-decoration:none href=#references aria-label=References>References</a></li></ul>
</blockquote>
</details>
</div>
<div id=contentBody>
<h2 id=a-brief-intro>A Brief Intro</h2>
<p>Have you wondered &ldquo;how can we test a linux kernel without breaking our linux
operating system installation?&rdquo;. One of the method is using virtual machine
(VM) and in this post we&rsquo;ll use arch linux in virtual machine to try out
different version of linux kernel.</p>
<p>There are 2 scenarios that we will discuss on this post:</p>
<ol>
<li>Using arch linux VM with arch linux as host system.</li>
<li>Using arch linux VM with different linux distro as host system.</li>
</ol>
<p>We&rsquo;re going to work with 2 systems on 1 machine, so we need to know which
command need to run on which machine. For that purpose, we&rsquo;re going to use
this indicator to differentiate:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host   # for real machine system</span>
<span style=color:#999;font-style:italic># @guest  # for virtual machine system</span>
</code></pre></div><h2 id=arch-linux-as-host-system>Arch Linux as Host System</h2>
<p>The prerequisite for this scenario is that we need to use arch linux on the
real machine or host machine we want to install the virtual machine.</p>
<p>After we make sure that the host machine system we have is using arch linux,
the first thing we need to do is create a file to store arch linux
installation for the virtual machine. We can define how much space we&rsquo;ll
allocate to the installation, but in this post we&rsquo;ll use 15G just to be save.
To create a file for virtual machine OS installation, we can use this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
truncate -s 15g arch-linux-disk.raw
</code></pre></div><p>We can name the file whatever we want, but in this case, we&rsquo;ll use
<code>arch-linux-disk</code>.</p>
<p>After that, we need to create a filesystem volume by formatting the file
into <code>ext4</code> with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
mkfs.ext4 arch-linux-disk.raw
</code></pre></div><p>And then, we can mount the filesystem partition into <code>/mnt</code> like this
(assuming we&rsquo;re not login as root user):</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
sudo mount arch-linux-disk.raw /mnt
</code></pre></div><blockquote>
<p>If your <code>/mnt</code> is occupied, you can use another directory such as <code>vm</code>, like
this: <code>sudo mount --mkdir arch-linux-disk.raw vm</code></p>
</blockquote>
<p>After mounting the filesystem, make sure <code>arch-install-scripts</code> and <code>qemu-base</code>
package installed on our system by running this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
sudo pacman -S arch-install-scripts qemu-base
</code></pre></div><blockquote>
<p><code>arch-install-scripts</code> contains some useful scripts to install arch linux such
as <code>pacstrap</code> and <code>arch-chroot</code>. <code>qemu-base</code> is for creating the virtual
machine we will use later.</p>
</blockquote>
<p>After those packages installed, we can use this command to install arch linux
on <code>arch-linux-disk.raw</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
sudo pacstrap -c /mnt base base-devel vim dhcpcd
</code></pre></div><blockquote>
<p>flag <code>-c</code> is to use package cache on host system, so we only need to
download some out of date packages rather than downloading all the packages.
<code>base</code> is a package for basic arch linux installation and <code>base-devel</code> is
for packages such as <code>sudo</code> and <code>grep</code>. <code>vim</code> is my editor of choice, so you
don&rsquo;t have to install this if you don&rsquo;t want to. <code>dhcpcd</code> is to connect the
virtual machine system to the internet.</p>
</blockquote>
<p>After everything installed, we can go into the new filesystem with this
command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
sudo arch-chroot /mnt
</code></pre></div><p>After that, we can setup password for root user with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
passwd
</code></pre></div><p>Also, we can start <code>dhcpcd</code> for internet connection on our virtual machine
with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
systemctl <span style=color:#24909d>enable</span> --now dhcpcd
</code></pre></div><p>To exit from the guest filesystem, we can use <code>ctrl-d</code> or <code>exit</code> command.
After exit from the guest filesystem, we can unmount the filesystem using this
command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
sudo umount /mnt
</code></pre></div><h3 id=use-custom-linux-kernel-on-qemu-vm>Use Custom Linux Kernel on QEMU VM</h3>
<p>Before we spin up our virtual machine, we need to compile the linux kernel.</p>
<p>First thing we need to do is download the linux kernel source code from one of
available source on <a href=https://web.git.kernel.org/pub/scm/linux/kernel/git target=_blank rel="noreferrer noopener">https://web.git.kernel.org/pub/scm/linux/kernel/git</a>
. In
this post, we will download the source from Linux Torvalds source code. For
example, let&rsquo;s say we want to download the source code for tag v6.14, we can
use <code>wget</code> like this:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
wget https://web.git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-6.14.tar.gz
</code></pre></div><p>Or we can just click on the Download link. Or we can clone the repo with this
command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
git clone --depth=<span style=color:#3677a9>1</span> git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git torvalds-kernel
</code></pre></div><blockquote>
<p><code>--depth=1</code> means that we download 1 commit instead of all the commits.
<code>torvalds-kernel</code> is the directory name where we clone the linux kernel source
code git repository (instead of naming it <code>linux</code>, we name it
<code>torvalds-kernel</code>).</p>
</blockquote>
<p>After we download the linux kernel source code, we can change directory into
it. And then, we can create a basic config x86_64 config using this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
make x86_64_defconfig
</code></pre></div><p>And then we need to add config for virtual machine with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
make kvm_guest.config
</code></pre></div><p>After that, we can compile the linux kernel with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
make -j &lt;n&gt;
</code></pre></div><blockquote>
<p><code>&lt;n></code> is how much threads we use. For example, <code>make -j 8</code> means we use 8
threads.</p>
</blockquote>
<p>We can change the config with command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>make nconfig
</code></pre></div><blockquote>
<p>Please keep in mind, DO NOT directly edit the <code>.config</code> file. Use <code>make nconfig</code> instead.</p>
</blockquote>
<p>After we finish compiling the linux kernel, we can use that linux kernel in
our QEMU virtual machine with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
qemu-system-x86_64 <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -hda /path/to/arch-linux-disk.raw <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -m 2g <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -nographic <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -kernel /path/to/linux-6.14/arch/x86/boot/bzImage <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -append <span style=color:#ed9d13>&#34;root=/dev/sda rw console=ttyS0 loglevel=5&#34;</span> <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -enable-kvm <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -nic user,hostfwd=tcp::2222-:22
</code></pre></div><p>For example:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
qemu-system-x86_64 <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -hda <span style=color:#40ffff>$HOME</span>/.local/state/qemu/kernel-dev-disk.raw <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -m 2g <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -nographic <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -kernel <span style=color:#40ffff>$HOME</span>/.local/state/qemu/linux-6.14-rc5/arch/x86/boot/bzImage <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -append <span style=color:#ed9d13>&#34;root=/dev/sda rw console=ttyS0 loglevel=5&#34;</span> <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -enable-kvm <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -nic user,hostfwd=tcp::2222-:22
</code></pre></div><p>Here&rsquo;s a brief explanation of each flags:</p>
<ul>
<li><code>-hda</code> is to use a file as a hard disk. <code>-hda</code> is equivalent to <code>sda</code>
partition, <code>-hdb</code> is equivalent to <code>sdb</code>, and so on.</li>
<li><code>-m</code> is RAM size for the virtual machine.</li>
<li><code>-nographic</code> make QEMU run on the terminal instead of graphical window.</li>
<li><code>-kernel</code> is to define the custom kernel we&rsquo;ll use in virtual machine.</li>
<li><code>-append</code> is to define kernel parameters we&rsquo;ll be using. We can&rsquo;t use this
without <code>-kernel</code> flag. For more info about kernel parameters, we can take a
look the <a href=https://www.kernel.org/doc/html/v4.14/admin-guide/kernel-parameters.html target=_blank rel="noreferrer noopener">kernel
docs</a>
.</li>
<li><code>-enable-kvm</code> is to enable KVM virtualization support (if available).</li>
<li><code>-nic</code> is to forward internet connection of host machine to virtual machine.</li>
</ul>
<p>To exit the virtual machine in <code>nographic</code> mode, we can use <code>ctrl-a x</code>.</p>
<h2 id=another-linux-distro-as-host-system>Another Linux Distro as Host System</h2>
<p>If we use another linux distro, we need to install arch linux in virtual
machine from scratch. You can take a look at <a href=../install-arch-linux-on-virtual-machine.md>my previous
post</a>
for how to
install arch linux using QEMU. Please keep in mind that you need to install
<code>qemu</code> and <code>vncviewer</code> package on your host system.</p>
<h3 id=use-custom-linux-kernel-on-qemu-vm-1>Use Custom Linux Kernel on QEMU VM</h3>
<p>After installing arch linux in virtual machine, we need to compile the linux
kernel based on the kernel config in the virtual machine.</p>
<p>We can run the virtual machine with shared directory with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
qemu-system-x86_64 <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -m 2g <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -enable-kvm <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -fsdev local,id=fs1,path=/path/to/linux-kernel,security_model=none <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -device virtio-9p-pci,fsdev=fs1,mount_tag=shared_directory <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -nic user,hostfwd=tcp::2222-:22 <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    &lt;qemu-image&gt;
</code></pre></div><p>For example:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
qemu-system-x86_64 <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -m 2g <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -enable-kvm <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -fsdev local,id=fs1,path=<span style=color:#40ffff>$HOME</span>/.local/state/qemu/linux-6.14,security_model=none <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -device virtio-9p-pci,fsdev=fs1,mount_tag=shared_directory <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    -nic user,hostfwd=tcp::2222-:22 <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>    arch-linux-img
</code></pre></div><blockquote>
<p>Please don&rsquo;t forget to add the shared directory in <code>/etc/fstab</code>.</p>
</blockquote>
<p>In the example above, we&rsquo;re using the linux kernel source code directory as a
shared directory.</p>
<p>Inside the virtual machine, we need to copy the kernel config into the
shared directory. Assuming our shared directory is in <code>/home/user/shared</code>,
we can use this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
zcat /proc/config.gz &gt; /home/user/shared/.config
</code></pre></div><p>After we got the config, we need to adjust the config so that we
only compile linux kernel with the module we need rather than compiling with
all module enabled. This can save time to compile the linux kernel. To do that
we can use this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
make localmodconfig
</code></pre></div><p>Sometimes, there are new features or new config parameters in the
source code repo and we need to confirm if we want to add those new
config parameters in our <code>.config</code> file or not. To reduce the amount of
confirmation we need to make, we can use this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
make olddefconfig
</code></pre></div><p>Also, we need to add a config for virtual machine with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
make kvm_guest.config
</code></pre></div><p>If we want to edit some config parameters, we can use:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
make nconfig
</code></pre></div><p>After that, we can shutdown the virtual machine and compile the linux kernel
with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
make -j &lt;n&gt;
</code></pre></div><blockquote>
<p><code>&lt;n></code> is how much threads we use. For example, <code>make -j 8</code> means we use 8
threads.</p>
</blockquote>
<p>And then, we need to compile the linux kernel modules with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @host</span>
make modules
</code></pre></div><p>After we compile both linux kernel and the modules, we can turn on the virtual
machine again and put the modules into <code>/lib/modules/&lt;kernel-name></code> in
the virtual machine with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
sudo make modules_install
</code></pre></div><p>And then, we need to copy the linux kernel into <code>/boot</code> with this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
sudo cp /home/user/shared/arch/x86/boot/bzImage /boot/vmlinuz-&lt;name&gt;
</code></pre></div><blockquote>
<p>We can use any <code>&lt;name></code> we want, but to make it easier to organize, i
suggest you use the same <code>&lt;name></code> in the following step.</p>
</blockquote>
<p>After that, we need to copy the default mkinitcpio preset like this:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
sudo cp /etc/mkinitcpio.d/linux.preset /etc/mkinitcpio.d/linux-&lt;name&gt;.preset
</code></pre></div><p>And then, we need to replace <code>ALL_kver</code>, <code>default_image</code>, and <code>fallback_image</code>
with the <code>&lt;name></code> we assign before. For example, let&rsquo;s say we use <code>torvalds-vm</code>
as <code>&lt;name></code>, we can use something like this:</p>
<pre tabindex=0><code>...
ALL_kver=&quot;/boot/vmlinuz-torvalds-vm&quot;
...
default_image=&quot;/boot/initramfs-torvalds-vm.img&quot;
...
fallback_image=&quot;/boot/initramfs-torvalds-vm-fallback.img&quot;
</code></pre><p>After that, we need to generate <code>initramfs</code> using this command:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
sudo mkinitcpio -p linux-&lt;name&gt;
</code></pre></div><p>Assuming we&rsquo;re using <code>grub</code> as our bootloader in a virtual machine, we need to
update the <code>grub</code> config like this:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#999;font-style:italic># @guest</span>
sudo grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div><p>Now, we need to reboot the virtual machine and check if everything works fine.
If we check on <code>grub</code> &ldquo;Advanced options for Arch Linux&rdquo;, we should we able to
see our custom linux kernel.</p>
<p>Alright, that&rsquo;s it. See you next time!</p>
<h2 id=references>References</h2>
<ul>
<li><a href=https://andrealmeid.com/post/2020-03-10-bootstrap-arch/ target=_blank rel="noreferrer noopener">Create an ArchLinux image for kernel
testing</a>
</li>
<li><a href=https://flusp.ime.usp.br/kernel/use-qemu-to-play-with-linux/ target=_blank rel="noreferrer noopener">FLUSP Kernel Compilation and
Installation</a>
</li>
</ul>
</div>
<footer>
<p>
&copy; 2020-present <a style=text-decoration:none href=https://bruhtus.github.io/resume target=_blank rel="noreferrer noopener">Robertus Chris</a>
<span>&#183;</span>
<a style=text-decoration:none href=https://bruhtus.github.io/index.xml target=_blank rel="noreferrer noopener">RSS Feed</a>
<span>&#183;</span>
Based on <a style=text-decoration:none href=https://github.com/koirand/pulp/ target=_blank rel="noreferrer noopener">pulp</a> and <a style=text-decoration:none href=https://github.com/adityatelange/hugo-PaperMod target=_blank rel="noreferrer noopener">papermod</a> theme
</p>
</footer>
<button onclick=topFunction() id=myBtn title="Go to top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d0d0d0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
</button>
<script>var mybutton=document.getElementById("myBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://bruhtus.github.io/js/custom.js></script>
</body>
</html>