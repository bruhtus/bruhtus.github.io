<!doctype html><html>
<head>
<title>
Golang Simple Query Composer With Text Template and Pgx
</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=author content="Robertus Chris">
<link rel="shortcut icon" type=image/x-icon href=https://bruhtus.github.io/img/favicon.ico>
<link rel=stylesheet href=https://bruhtus.github.io/style.min.4f970aa135421035a71bdc9bbd750aa2cfbe0ddb080ab1ec5db4173f45494cad.css integrity="sha256-T5cKoTVCEDWnG9ybvXUKos++DdsICrHsXbQXP0VJTK0=">
<link disabled rel=stylesheet href=https://bruhtus.github.io/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB+BLd7VPoFFdCmg9OezbJR26lg/h+Wb3/zb8I=">
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.8.1/css/all.css integrity=sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf crossorigin=anonymous>
<link rel=preconnect href=https://fonts.gstatic.com>
<link href="https://fonts.googleapis.com/css2?family=Bitter:wght@300&family=EB+Garamond&family=PT+Sans&family=Sura&family=Zilla+Slab&family=Inconsolata&family=Libre+Baskerville&display=swap" rel=stylesheet>
<link rel=stylesheet href=https://bruhtus.github.io/css/custom.css>
<meta property="og:title" content="Golang Simple Query Composer With Text Template and Pgx">
<meta property="og:description" content="For backend development at work, we just transitioned from Node.js to golang recently. We use pgx as our PostgreSQL driver. I&rsquo;m not quite sure why we choose pgx as our PostgreSQL driver and not using ORM like gorm, so we won&rsquo;t talk about that here. My principal is to adapt to the tech stack that the project use rather than forcing what i&rsquo;m familiar with, so i don&rsquo;t really mind.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://bruhtus.github.io/posts/golang-simple-query-composer-with-text-template-and-pgx/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2025-06-22T04:10:37+07:00">
<meta property="article:modified_time" content="2025-06-22T04:10:37+07:00">
<meta itemprop=name content="Golang Simple Query Composer With Text Template and Pgx">
<meta itemprop=description content="For backend development at work, we just transitioned from Node.js to golang recently. We use pgx as our PostgreSQL driver. I&rsquo;m not quite sure why we choose pgx as our PostgreSQL driver and not using ORM like gorm, so we won&rsquo;t talk about that here. My principal is to adapt to the tech stack that the project use rather than forcing what i&rsquo;m familiar with, so i don&rsquo;t really mind."><meta itemprop=datePublished content="2025-06-22T04:10:37+07:00">
<meta itemprop=dateModified content="2025-06-22T04:10:37+07:00">
<meta itemprop=wordCount content="730">
<meta itemprop=keywords content="Golang,"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<h1>Golang Simple Query Composer With Text Template and Pgx</h1>
<header>
<div class=cd>
<h2><a style=text-decoration:none class=cd href=https://bruhtus.github.io/posts>cd ..</a> || <a style=text-decoration:none class=cd href=https://bruhtus.github.io/>cd</a></h2>
</div>
</header>
<p class=date>
June 22, 2025
<span>&#183;</span>
4 mins
<span>&#183;</span>
Robertus Chris
</p>
<div id=tags>
<ul>
<li><a style=text-decoration:none href=https://bruhtus.github.io/tags/golang/>Golang</a></li>
</ul>
</div>
<div id=contentBody>
<p>For backend development at work, we just transitioned from <code>Node.js</code> to <code>golang</code>
recently. We use <code>pgx</code> as our PostgreSQL driver. I&rsquo;m not quite sure why we
choose <code>pgx</code> as our PostgreSQL driver and not using ORM like <code>gorm</code>, so we
won&rsquo;t talk about that here. My principal is to adapt to the tech stack that
the project use rather than forcing what i&rsquo;m familiar with, so i don&rsquo;t really
mind.</p>
<p>Just to be clear, as my workplace tech stack move to golang, that is also the
first time i learn golang. So i have no prior experience with golang. In fact,
by the time i write this post, i have less than one year experience with
golang. You could say that i&rsquo;m an inexperience golang developer that are
trying things out and see if it works or not.</p>
<p>With that in mind, let&rsquo;s moving into the topic. The problem i&rsquo;m trying to
solve here is the mess when we&rsquo;re trying to compose an SQL query for <code>pgx</code>.
Currently at work, when we compose the SQL query is that we use <code>+=</code> to append
new string into existing SQL query string.</p>
<p>Here&rsquo;s an example, let&rsquo;s say we have a table <code>articles</code> with this columns:</p>
<pre tabindex=0><code>id
author
title
content
created_at
updated_at
</code></pre><p>And then we want to see how many articles each author has. With raw SQL query,
we can do something like this:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#6ab825;font-weight:700>select</span><span style=color:#666>
</span><span style=color:#666></span>articles.author,<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>count</span>(*)<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>from</span><span style=color:#666> </span>articles<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>group</span><span style=color:#666> </span><span style=color:#6ab825;font-weight:700>by</span><span style=color:#666> </span>articles.author;<span style=color:#666>
</span></code></pre></div><p>If that&rsquo;s all we need, then we can just write those SQL query as is in one
string. Now the problem is, when we want to show only specific author. The
raw SQL query would be something like this:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#6ab825;font-weight:700>select</span><span style=color:#666>
</span><span style=color:#666></span>articles.author,<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>count</span>(*)<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>from</span><span style=color:#666> </span>articles<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>where</span><span style=color:#666> </span>articles.author<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>ilike</span><span style=color:#666> </span><span style=color:#ed9d13>&#39;%robertus%&#39;</span><span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>group</span><span style=color:#666> </span><span style=color:#6ab825;font-weight:700>by</span><span style=color:#666> </span>articles.author;<span style=color:#666>
</span></code></pre></div><p>Now we have two state, the one with all the authors and the one with specific
author (searching feature). Currently at work, we compose those SQL query like
this:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>var</span> args []<span style=color:#6ab825;font-weight:700>interface</span>{}

query := <span style=color:#ed9d13>`
</span><span style=color:#ed9d13>select
</span><span style=color:#ed9d13>articles.author,
</span><span style=color:#ed9d13>count(*)
</span><span style=color:#ed9d13>from articles
</span><span style=color:#ed9d13>`</span>

<span style=color:#999;font-style:italic>// Assume `Author` type is `string`.
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>if</span> filter.Author != <span style=color:#ed9d13>&#34;&#34;</span> {
        query += <span style=color:#ed9d13>`where articles.author ilike $1`</span>
        args = <span style=color:#24909d>append</span>(args, filter.Author)
}

query += fmt.<span style=color:#447fcf>Sprintf</span>(<span style=color:#ed9d13>`\n%s`</span>, <span style=color:#ed9d13>&#34;group by articles.author&#34;</span>)

<span style=color:#999;font-style:italic>// Assume `db` type is `*pgxpool.Pool`.
</span><span style=color:#999;font-style:italic></span>rows, err := db.<span style=color:#447fcf>Query</span>(ctx, query, args...)
<span style=color:#6ab825;font-weight:700>defer</span> rows.<span style=color:#447fcf>Close</span>()
...
</code></pre></div><p>I see at least 2 problems with the current query composer:</p>
<ol>
<li>What if we want to add another <code>where</code> filter to the query?</li>
<li>What if we want to add <code>where</code> filter in a sub-query?</li>
</ol>
<p>Now, what i proposed is that we use golang <code>text/template</code> package. I just
recently found out about <code>text/template</code> package and i think we can use that
as a simple SQL query composer.</p>
<p>The concept of using <code>text/template</code> package as SQL query composer is to use a
placeholder inside the base query string.</p>
<p>With the previous scenario, we can use <code>text/template</code> package like this:</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#999;font-style:italic>// Use named arguments instead of positional arguments.
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>var</span> (
        composedFilter []<span style=color:#6ab825;font-weight:700>string</span>

        queryBuilder    = <span style=color:#24909d>new</span>(strings.Builder) <span style=color:#999;font-style:italic>// Using `strings` package.
</span><span style=color:#999;font-style:italic></span>        conditionalTmpl = <span style=color:#24909d>make</span>(<span style=color:#6ab825;font-weight:700>map</span>[<span style=color:#6ab825;font-weight:700>string</span>]<span style=color:#6ab825;font-weight:700>string</span>)
        filterArgs      = <span style=color:#24909d>make</span>(pgx.StrictNamedArgs)
)

<span style=color:#999;font-style:italic>// The `-` at `{{end -}}` is to remove whitespace after the line.
</span><span style=color:#999;font-style:italic></span>baseQuery := <span style=color:#ed9d13>`
</span><span style=color:#ed9d13>select
</span><span style=color:#ed9d13>articles.author,
</span><span style=color:#ed9d13>count(*)
</span><span style=color:#ed9d13>from articles
</span><span style=color:#ed9d13></span><span style=color:#cd2828;font-weight:700>{{</span><span style=color:#6ab825;font-weight:700>if</span><span style=color:#666> </span><span style=color:#bbb>.Where</span><span style=color:#cd2828;font-weight:700>}}{{</span><span style=color:#bbb>.Where</span><span style=color:#cd2828;font-weight:700>}}{{</span><span style=color:#6ab825;font-weight:700>end</span><span style=color:#666> </span><span style=color:#cd2828;font-weight:700>-}}</span><span style=color:#ed9d13>
</span><span style=color:#ed9d13>group by articles.author
</span><span style=color:#ed9d13>`</span>

<span style=color:#999;font-style:italic>// Assume `Author` type is `string`.
</span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>if</span> filter.Author != <span style=color:#ed9d13>&#34;&#34;</span> {
        composedFilter = <span style=color:#24909d>append</span>(composedFilter, <span style=color:#ed9d13>`articles.author ilike @author`</span>)
        <span style=color:#999;font-style:italic>// Key `author` is the named argument `@author`, so make sure the name is
</span><span style=color:#999;font-style:italic></span>        <span style=color:#999;font-style:italic>// the same.
</span><span style=color:#999;font-style:italic></span>        filterArgs[<span style=color:#ed9d13>&#34;author&#34;</span>] = fmt.<span style=color:#447fcf>Sprintf</span>(<span style=color:#ed9d13>&#34;%%%s%%&#34;</span>, filter.Author)
}

<span style=color:#6ab825;font-weight:700>if</span> <span style=color:#24909d>len</span>(composedFilter) &gt; <span style=color:#3677a9>0</span> {
        <span style=color:#999;font-style:italic>// This is a placeholder in `{{if .Where}}...` so make sure the name
</span><span style=color:#999;font-style:italic></span>        <span style=color:#999;font-style:italic>// is the same.
</span><span style=color:#999;font-style:italic></span>        conditionalTmpl[<span style=color:#ed9d13>&#34;Where&#34;</span>] = fmt.<span style=color:#447fcf>Sprintf</span>(
                <span style=color:#ed9d13>&#34;where %s\n&#34;</span>,
                strings.<span style=color:#447fcf>Join</span>(composedFilter, <span style=color:#ed9d13>` AND `</span>),
        )
}

queryTmpl := template.<span style=color:#447fcf>Must</span>(template.<span style=color:#447fcf>New</span>(<span style=color:#ed9d13>&#34;baseQuery&#34;</span>).<span style=color:#447fcf>Parse</span>(baseQuery))

<span style=color:#6ab825;font-weight:700>if</span> err != queryTmpl.<span style=color:#447fcf>Execute</span>(queryBuilder, conditionalTmpl); err != <span style=color:#6ab825;font-weight:700>nil</span> {
        ...
}

query := queryBuilder.<span style=color:#447fcf>String</span>()

<span style=color:#999;font-style:italic>// Assume `db` type is `*pgxpool.Pool`.
</span><span style=color:#999;font-style:italic></span>rows, err := db.<span style=color:#447fcf>Query</span>(ctx, query, filterArgs)
<span style=color:#6ab825;font-weight:700>defer</span> rows.<span style=color:#447fcf>Close</span>()
...
</code></pre></div><p>With the approach above, we can add some placeholder for SQL query <code>where</code>
clause, or <code>order by</code> clause, or other things that is optional to the feature.</p>
<p>My concern with the <code>text/template</code> approach is that i don&rsquo;t know the failure
condition for <code>template.Must()</code>, so that might become a consideration when
deciding to use this approach or not. It&rsquo;s similar to when <code>google/uuid</code>
package panic when using <code>uuid.New()</code>, you can check it out on <a href=https://github.com/google/uuid/issues/97 target=_blank rel="noreferrer noopener">this
issue about the context</a>
.</p>
<p>I already proposed this mechanism at work but i&rsquo;m not sure if this mechanism
will be used. So, i&rsquo;m posting this in case someone need an inspiration for
simple SQL query composer.</p>
<p>Alright, that&rsquo;s it. See you next time!</p>
<h2 id=references>References</h2>
<ul>
<li><a href=https://stackoverflow.com/a/31742265 target=_blank rel="noreferrer noopener">Stackoverflow format go string</a>
.</li>
</ul>
</div>
<footer>
<p>
&copy; 2020-present <a style=text-decoration:none href=https://github.com/bruhtus/resume target=_blank rel="noreferrer noopener">Robertus Chris</a>
<span>&#183;</span>
<a style=text-decoration:none href=https://bruhtus.github.io/index.xml target=_blank rel="noreferrer noopener">RSS Feed</a>
<span>&#183;</span>
Based on <a style=text-decoration:none href=https://github.com/koirand/pulp/ target=_blank rel="noreferrer noopener">pulp</a> and <a style=text-decoration:none href=https://github.com/adityatelange/hugo-PaperMod target=_blank rel="noreferrer noopener">papermod</a> theme
</p>
</footer>
<button onclick=topFunction() id=myBtn title="Go to top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d0d0d0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
</button>
<script>var mybutton=document.getElementById("myBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://bruhtus.github.io/js/custom.js></script>
</body>
</html>